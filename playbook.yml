---
- hosts: all
  become: true
  vars:
    openstack_master_address: "{{ ansible_default_ipv4.address }}"
  pre_tasks:
    - name: Set environment
      with_items:
        - LANG=en_US.utf-8
        - LC_ALL=en_US.utf-8
      lineinfile:
        dest: /etc/environment
        line: "{{ item }}"
    - name: Stop and disable networkmanager
      service:
        name: NetworkManager
        state: stopped
        enabled: false
    - name: Install release package
      yum:
        name: centos-release-openstack-pike
    - name: Update all package
      yum:
        name: '*'
        state: latest
    - name: Install packstack
      yum:
        name: openstack-packstack
    - name: Deploy answerfile
      register: registered_answerfile
      template:
        src: answerfile.j2
        dest: /root/answerfile
    - name: Execute packstack
      when: registered_answerfile|changed
      command: packstack --answer-file=/root/answerfile
      args:
        creates: /root/keystonerc_admin
    - name: Install shade
      yum:
        name: python2-shade
  roles:
    - openstack.projects
    - openstack.neutron-networks
